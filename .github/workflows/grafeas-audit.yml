name: Grafeas Audit Trail

on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: openai
  GRAFEAS_ADDR: localhost:8080

jobs:
  full-ci:
    name: Full Grafeas CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 1. Install unzip (for protoc zip), build tools
      - name: Install unzip & curl
        run: sudo apt-get update && sudo apt-get install -y unzip curl

      # 2. Install protoc
      - name: Install protoc
        run: |
          PROTOC_VERSION=21.12
          curl -sSL \
            "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip" \
            -o protoc.zip
          unzip protoc.zip -d protoc3
          sudo mv protoc3/bin/protoc /usr/local/bin/
          sudo mv protoc3/include/* /usr/local/include/
          rm -rf protoc.zip protoc3

      # 3. Install grpcurl
      - name: Install grpcurl
        run: |
          GRPCURL_VERSION=1.8.8
          curl -sSL \
            "https://github.com/fullstorydev/grpcurl/releases/download/v${GRPCURL_VERSION}/grpcurl_${GRPCURL_VERSION}_linux_x86_64.tar.gz" \
            | sudo tar -xz -C /usr/local/bin

      # 4. Build your local Grafeas server image
      - name: Build Grafeas server
        run: docker build -t grafeas-server:latest .

      # 5. Start Grafeas server in background
      - name: Start Grafeas server
        run: |
          docker run -d --name grafeas-server -p 8080:8080 grafeas-server:latest
          # wait until grpcurl can list services
          for i in {1..10}; do
            if grpcurl -plaintext localhost:8080 list; then
              echo "Grafeas is up"; break
            fi
            echo "Waiting for Grafeas..."; sleep 2
          done

      # 6. Generate the v1beta1 protoset
      - name: Generate Grafeas descriptor set
        run: |
          git clone https://github.com/googleapis/googleapis.git googleapis
          mkdir -p .gha
          protoc \
            -I . \
            -I googleapis \
            --include_imports \
            --include_source_info \
            --descriptor_set_out=.gha/grafeas-v1beta1.protoset \
            proto/v1beta1/*.proto

      # 7. Create the three Notes
      - name: Create BUILD note
        run: |
          grpcurl -plaintext \
            -protoset ./.gha/grafeas-v1beta1.protoset \
            -d '{"parent":"projects/'"${PROJECT_ID}"'","noteId":"'${{ github.repository }}'-build","note":{"kind":"BUILD","build":{"builderVersion":"gha-1.0.0"}}}' \
            $GRAFEAS_ADDR \
            grafeas.v1beta1.GrafeasV1Beta1.CreateNote

      - name: Create DEPLOYMENT note
        run: |
          grpcurl -plaintext \
            -protoset ./.gha/grafeas-v1beta1.protoset \
            -d '{"parent":"projects/'"${PROJECT_ID}"'","noteId":"'${{ github.repository }}'-deploy","note":{"kind":"DEPLOYMENT","deployable":{"resourceUri":["https://github.com/'"${{ github.repository }}"']}}}' \
            $GRAFEAS_ADDR \
            grafeas.v1beta1.GrafeasV1Beta1.CreateNote

      - name: Create VULNERABILITY note
        run: |
          grpcurl -plaintext \
            -protoset ./.gha/grafeas-v1beta1.protoset \
            -d '{"parent":"projects/'"${PROJECT_ID}"'","noteId":"'${{ github.repository }}'-vuln","note":{"kind":"VULNERABILITY","shortDescription":"CI-driven vuln scan for '"${{ github.repository }}"'","vulnerability":{"severity":"UNSPECIFIED"}}}' \
            $GRAFEAS_ADDR \
            grafeas.v1beta1.GrafeasV1Beta1.CreateNote

      # 8. Build & scan your Docker image
      - name: Build Docker Image
        run: docker build -t "${{ github.repository }}:latest" .

      - name: Emit BUILD occurrence
        run: |
          grpcurl -plaintext \
            -protoset ./.gha/grafeas-v1beta1.protoset \
            -d '{"parent":"projects/'"${PROJECT_ID}"'","occurrence":{"noteName":"projects/'"${PROJECT_ID}"'/notes/'"${{ github.repository }}'-build","resourceUri":"docker://'${{ github.repository }}':latest","build":{"provenance":{"id":"build-'${{ github.run_id }}'","projectId":"'"${PROJECT_ID}"'","commands":[{"name":"docker build","args":["-t","'"${{ github.repository }}':latest"]}],"createTime":"'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"}}}}' \
            $GRAFEAS_ADDR \
            grafeas.v1beta1.GrafeasV1Beta1.CreateOccurrence

      - name: Run container-scanning plugin
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -e GRAFEAS_ADDR=$GRAFEAS_ADDR \
            gcr.io/grafeas/container-scanning:latest \
              image "${{ github.repository }}:latest" --project="$PROJECT_ID"

      # 9. Emit DEPLOYMENT occurrence
      - name: Emit DEPLOYMENT occurrence
        run: |
          grpcurl -plaintext \
            -protoset ./.gha/grafeas-v1beta1.protoset \
            -d '{"parent":"projects/'"${PROJECT_ID}"'","occurrence":{"noteName":"projects/'"${PROJECT_ID}"'/notes/'"${{ github.repository }}'-deploy","resourceUri":"docker://'${{ github.repository }}':latest","deployment":{"deployment":{"userEmail":"'"${{ github.actor }}"'@users.noreply.github.com","deployTime":"'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"}}}}' \
            $GRAFEAS_ADDR \
            grafeas.v1beta1.GrafeasV1Beta1.CreateOccurrence
